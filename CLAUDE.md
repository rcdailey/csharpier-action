# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with
code in this repository.

## ABSOLUTE DIRECTIVES

After changes:

- ALWAYS run `npm run bundle`
- ALWAYS execute tests with `npm test`

Testing Requirements:

- Test BEHAVIOR, not implementation
- Integration test approach utilizes ports and adapters (hexagonal architecture)
- No overlap between new or existing tests
- Test is not brittle, flakey, or high maintenance (tied up in implementation
  detail)

## Project Overview

This is a GitHub Action that runs CSharpier formatting checks on pull requests
and provides inline review comments for formatting violations. It uses Node.js
24, TypeScript with ES modules, and the GitHub Actions toolkit.

## Development Commands

### Build and Package

```bash
npm run package              # Build dist/index.js bundle with rollup
npm run package:watch        # Watch mode for development
npm run bundle              # Format + package in one command
npm run all                 # Complete workflow: format + lint + test + coverage + package
```

### Testing

```bash
npm test                    # Run tests with coverage
npm run ci-test            # Run tests in CI mode (with NODE_OPTIONS flags)
npm run coverage           # Generate coverage badge
```

### Code Quality

```bash
npm run format:write       # Format code with prettier
npm run format:check       # Check formatting without changes
npm run lint              # Run eslint
```

### Local Testing

```bash
npm run local-action      # Test action locally using @github/local-action
```

## Architecture

### Core Workflow (src/main.ts)

The action executes this sequence:

1. Validates it's running on a pull request event
2. Installs CSharpier as a global dotnet tool
3. Fetches changed C# files (.cs, .csx) from the PR using GitHub API
4. Retrieves existing review comments created by this action (identified by HTML
   marker)
5. Runs `dotnet csharpier check` on changed files
6. Manages comments: creates new ones for violations, resolves old ones for
   fixed files
7. Sets output and fails check if violations remain

### Module Responsibilities

**src/csharpier-runner.ts**: CSharpier installation and execution

- `installCSharpier()`: Installs as global dotnet tool with version support
- `checkFiles()`: Runs check command and captures output
- `parseCSharpierOutput()`: Parses stdout to extract unformatted file paths
- Exit codes: 0 = formatted, 1 = violations found, 2+ = error

**src/comment-manager.ts**: GitHub PR review comment lifecycle

- Uses HTML marker `<!-- csharpier-action -->` to identify action-created
  comments
- `getExistingComments()`: Fetches and filters action's review comments
- `createViolationComment()`: Creates comment at line 1 of file with
  instructions
- `resolveFixedComments()`: Creates reply to mark comment as resolved when file
  is fixed

**src/pr-files.ts**: PR file discovery

- `getChangedCSharpFiles()`: Fetches PR files via GitHub API, filters for
  .cs/.csx extensions and non-removed status

**src/types.ts**: TypeScript interfaces for PR files, comments, and CSharpier
results

**src/index.ts**: Entry point that calls run() and handles errors

### Build System

Uses Rollup to bundle TypeScript source into single dist/index.js file:

- Entry: src/index.ts
- Output: ES module format with sourcemap
- Plugins: typescript, node-resolve, commonjs
- Target: Node.js 24 runtime

### Testing System

Jest with ts-jest for ESM support:

- Test files: `**/*.test.ts`
- Coverage collection from src/\*\*
- Uses ts-jest-resolver for ESM resolution
- Coverage badge generation with make-coverage-badge

## Important Constraints

- Action ONLY runs on `pull_request` events (validated in main.ts)
- Requires `pull-requests: write` permission for creating review comments
- Requires .NET to be installed (user's workflow must include
  actions/setup-dotnet)
- Comments are created at line 1 of each file (GitHub API requirement for
  file-level comments)
- CSharpier must be installed as global tool (not local)

## dist/ Directory

The dist/ directory contains the bundled action code and MUST be committed:

- Generated by rollup from src/\*\*
- GitHub Actions runs dist/index.js directly (see action.yml)
- CI checks verify dist/ is up to date via check-dist.yml workflow
- Always run `npm run package` before committing changes

## ES Module Configuration

This project uses ES modules throughout:

- package.json has `"type": "module"`
- All imports must include .js extension (e.g., `from './types.js'` not
  `from './types'`)
- Jest configured with extensionsToTreatAsEsm and useESM options
